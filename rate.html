<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>CodeJam 2016</title>
    <style>
        body {
            margin: 0px;

            font-family: Calibri;

            color: #333333;
        }

        #header_bar {
            position: fixed;
            top: 0px;
            z-index: 200;

            height: 50px;
            width: 100%;
            box-shadow: 0px 0px 20px #1A1A1A;

            font-size: large;

            background-color: #262626;
            color: #D9D9D9;
        }

        #header_wrapper {
            margin: 0px 40px 0px 40px;
        }

        #header_placeholder {
            height: 50px;
            width: 100%;
        }

        #title {
	        float: left;
            margin-right: 30px;
            height: 50px;
            padding: 0px 10px 0px 10px;
        }

        #title_left {
            float: left;
            height: 50px;

            line-height: 50px;
            font-size: xx-large;
            font-weight: bold;

            color: #FFFFFF;
        }

        #menu {
            height: 50px;
        }

        #menu_right {
            float: right;
            height: 50px;

            line-height: 50px;
        }

        #header ul {
            margin: 0px;
            padding: 0px;
            overflow: hidden;

            list-style-type: none;
        }

        #header li {
            display: inline-block;
        }

        #header li a {
            margin: 0px;
            padding: 0px 10px 0px 10px;

            display: inline-block;
            text-decoration: none;

            color: #D9D9D9;
        }

        #header li a:hover {
            background-color: #1A1A1A;
            color: #FFFFFF;
        }

        #container {
            position: relative;
            overflow: auto;
            padding: 50px;
            clear: both;

            font-size: large;
        }

        #rating_image {
            max-height: 700px;
            max-width: 800px;
            padding: 10px;
            box-shadow: 0px 0px 10px #CCCCCC;
        }

        #star5 {
            width: 50px;
        }
        #star0 {
            width: 50px;
        }
        #star1 {
            width: 50px;
        }
        #star2 {
            width: 50px;
        }
        #star3 {
            width: 50px;
        }
        #star4 {
            width: 50px;
        }

        #footer {
            margin-bottom: 20px;

            text-align: center;

            font-size: large;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="header_bar">
            <div id="header_wrapper">
                <a href="">
                    <div id="title">
                        <div id="title_left">CodeJam 2016</div>
                    </div>
                </a>
                <div id="menu">
                    <div id="menu_right">
                        <ul>
                            <li><a href="">About</a></li>
                            <li><a href="">Contact</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div id="header_placeholder"></div>
    </div>

    <div id="container" style="text-align: center">
        <div id="wrapper" style="display: inline-block;">
            <div id="left_div" style="float: left; width: 600px;">
                <img id="rating_image" src="" />
            </div>
            <div id="right_div" style="float: left; text-align: left; width: 500px; margin-left: 50px;">
                <div style="text-align: center;">
                    <h1 id="ratingHeader" style="margin-bottom: 20px;">Game of Thrones (2016)</h1>

                    <img id="star5" src="star_gray.png" onmouseover="onHoverStar(5)" onmouseout="onHoverStar(-1)" onclick="onClickStar(this.id)" style="cursor: pointer; margin-right: 20px; opacity: 0.3" />
                    <img id="star0" src="star_gray.png" onmouseover="onHoverStar(0)" onmouseout="onHoverStar(-1)" onclick="onClickStar(this.id)" style="cursor: pointer;" />
                    <img id="star1" src="star_gray.png" onmouseover="onHoverStar(1)" onmouseout="onHoverStar(-1)" onclick="onClickStar(this.id)" style="cursor: pointer;" />
                    <img id="star2" src="star_gray.png" onmouseover="onHoverStar(2)" onmouseout="onHoverStar(-1)" onclick="onClickStar(this.id)" style="cursor: pointer;" />
                    <img id="star3" src="star_gray.png" onmouseover="onHoverStar(3)" onmouseout="onHoverStar(-1)" onclick="onClickStar(this.id)" style="cursor: pointer;" />
                    <img id="star4" src="star_gray.png" onmouseover="onHoverStar(4)" onmouseout="onHoverStar(-1)" onclick="onClickStar(this.id)" style="cursor: pointer;" />

                    <br />

                    <div id="ratingComment" style="font-size: xx-large; margin: 20px 0px 30px 0px;">&nbsp;</div>

                    <table id="historyTable">
                        <tr id="historyTable_tr">
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_0_image" src="https://images-na.ssl-images-amazon.com/images/M/MV5BMjM5OTQ1MTY5Nl5BMl5BanBnXkFtZTgwMjM3NzMxODE@._V1_SY1000_CR0,0,674,1000_AL_.jpg" style="height: 80px; opacity: 1;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_1_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_2_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_3_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_4_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_5_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                        </tr>
                        <tr id="historyTable_tr">
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_6_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_7_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_8_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_9_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_10_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_11_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                        </tr>
                        <tr id="historyTable_tr">
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_12_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_13_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_14_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_15_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_16_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_17_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                        </tr>
                        <tr id="historyTable_tr">
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_18_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_19_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_20_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_21_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_22_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_23_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                        </tr>
                        <tr id="historyTable_tr">
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_24_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_25_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_26_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_27_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_28_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                            <td id="historyTable_td_0" style="width: 120px; height: 90px;">
                                <img id="historyTable_td_29_image" src="" style="height: 80px; opacity: 0.3;" />
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- <script data-main="scripts/main" src="scripts/require.js"></script> -->
    <script src="scripts/require.js"></script>
    <script>
    // Helper Methods
        function sendRequest(taskParams, fieldParams)
        {
          var xmlHttp = new XMLHttpRequest();
          var baseUrl = "https://api.themoviedb.org/3/"
          var apiKey = "api_key=" + jsonData["api-key"]
          var englishParam = "&language=en-US";
          var fullReq = baseUrl + taskParams + apiKey + englishParam + fieldParams
          xmlHttp.open( "GET", fullReq, false ); // false for synchronous request
          xmlHttp.send( null );
          var res= xmlHttp.responseText;
          return res;
        }

        function fetch_genres(jsonData){
          // ex URL "https://api.themoviedb.org/3/genre/tv/list?api_key=" + jsonData["api-key"] + "&language=en-US";
          var res = sendRequest("genre/tv/list?", "");
          return res
        }

        function fetch_most_pop_movies(jsonData){
          // ex URL "https://api.themoviedb.org/3/discover/movie?api_key=" + jsonData["api-key"] + "&sort_by=popularity.desc" +  "&language=en-US";
          var taskParams = "discover/movie?"
          var res = sendRequest(taskParams, "&sort_by=popularity.desc");
          res = JSON.parse(res)["results"]
          return res
        }

        function fetch_most_pop(jsonData){
          // ex URL // https://api.themoviedb.org/3/discover/tv?api_key=" + jsonData["api-key"] + "&sort_by=popularity.desc&page=1&timezone=America/New_York&include_null_first_air_dates=false
          var taskParams = "discover/tv?"
          var res = sendRequest(taskParams, "&sort_by=popularity.desc");
          res = JSON.parse(res)["results"]
          return res
        }

        function populate_show_info_arrays(jsonData, showInfos)
        {
          showInfos.forEach(
            function(entry){
              var id = entry["id"];
              var show_name = entry["original_name"];
              var year = entry["first_air_date"].split("-")[0];
              var baseImgUrl = "https://image.tmdb.org/"
              var imgDimUrl = "t/p/w500/"
              var jpgUrl = "xfWac8MTYDxujaxgPVcRD9yZaul.jpg"
              var jpgUrl = entry["poster_path"].substring(1);
              var fullImgUrl = baseImgUrl + imgDimUrl + jpgUrl;
              ratingTitles.push(show_name);
              ratingImgs.push(fullImgUrl);
              ratingYears.push(year);
          });
          return [ratingTitles, ratingImgs, ratingYears]
        }

        function convert_star_id_to_rating(starIndex)
        {
          return parseInt(starIndex.substring(starIndex.length - 1), 10)+1;
        }

        var ratingImgs = [];
        var ratingTitles = [];
        var ratingYears = [];

        // "MAIN" file for all JavaScript
        require(['scripts/creds.js'], function(data){
          // load creds.js with requireJS in order to expose API token key to this environment
          var mostPop = fetch_most_pop(jsonData);
          var display_limit = 3;
          var ratings = populate_show_info_arrays(jsonData, mostPop.splice(0,display_limit));
          var ratingTitles = ratings[0];
          var ratingImgs = ratings[1];
          var ratingYears = ratings[2];

          document.getElementById("rating_image").src = ratingImgs[0];
          document.getElementById("ratingHeader").innerHTML = ratingTitles[0] + " (" + ratingYears[0] + ")";
          for (var i = 0; i < ratingImgs.length ; i++) {
            document.getElementById("historyTable_td_" + i + "_image").src = ratingImgs[i];
          }
        });

        var currentRating = 0;
        var inTransition = false;
        var user_ratings = {};

        var onClickStar = function (starIndex) {
            if (!inTransition) {
                inTransition = true;
                currentRating++;
                var ratings_total = 3 // for testing purposes, we're only using 3 movies now
                if (currentRating < ratings_total) {
                  // if still more recommendations to do
                    var rating = convert_star_id_to_rating(starIndex)
                    var showname = $("#ratingHeader").text()
                    user_ratings[showname] = rating;

                    var intensity = 1;
                    var fadeOut = setInterval(function () {
                        if (intensity > 0) {
                            intensity -= 0.01;
                            document.getElementById("rating_image").style.opacity = intensity;
                            document.getElementById("ratingHeader").style.opacity = intensity;
                        }
                        else {
                            clearInterval(fadeOut);
                            document.getElementById("rating_image").src = ratingImgs[currentRating];
                            document.getElementById("ratingHeader").innerHTML = ratingTitles[currentRating] + " (" + ratingYears[currentRating] + ")";
                            var fadeIn = setInterval(function () {
                                if (intensity < 1) {
                                    intensity += 0.01;
                                    document.getElementById("historyTable_td_" + currentRating + "_image").style.opacity = 0.3 + intensity * 0.7;
                                    document.getElementById("rating_image").style.opacity = intensity;
                                    document.getElementById("ratingHeader").style.opacity = intensity;
                                }
                                else {
                                    clearInterval(fadeIn);
                                    inTransition = false;
                                }
                            }, 20);
                        }
                    }, 10);
                }
                else {
                    // execute request for recommendations
                    var rating = convert_star_id_to_rating(starIndex)
                    var showname = $("#ratingHeader").text()
                    user_ratings[showname] = rating;
                    console.log(user_ratings);
                }
            }
        }

        var onHoverStar = function (starIndex) {

            var stars = [];
            for (var i = 0; i < 6; i++) {
                stars.push(document.getElementById("star" + i));
            }
            var ratingComment = document.getElementById("ratingComment");

            if (starIndex == -1) {
                for (var i = 0; i < 5; i++) {
                    stars[i].src = "star_gray.png";
                }
                stars[5].style.opacity = "0.3";
                ratingComment.innerHTML = "&nbsp;";
            }
            else if (starIndex == 5) {
                stars[5].style.opacity = "0.5";
                ratingComment.innerHTML = "Haven't seen it";
            }
            else {
                for (var i = 0; i <= starIndex; i++) {
                    stars[i].src = "star_gold.png";
                }
                for (var i = starIndex + 1; i < 5; i++) {
                    stars[i].src = "star_gray.png";
                }
                var ratingComments = [];
                ratingComments.push("Poor...");
                ratingComments.push("Bad..");
                ratingComments.push("Fair");
                ratingComments.push("Good!");
                ratingComments.push("EXCELLENT!");
                ratingComment.innerHTML = ratingComments[starIndex];
            }
        }
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <div id="footer">
        &copy; 2016 Charles Liu, Eddy Lu
    </div>
</body>
</html>
